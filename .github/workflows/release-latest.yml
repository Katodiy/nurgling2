name: Build and Release to Latest

on:
  push:
    branches: [master]
    paths-ignore:
      - '*.md'
      - 'docs/**'

  workflow_dispatch:
    inputs:
      release_message:
        description: 'Release message (optional)'
        required: false
        default: ''

env:
  JAVA_VERSION: '17'
  RELEASE_REPO: aleksandrsvoboda/nurgling-release
  RELEASE_BRANCH: latest

jobs:
  build-and-release:
    runs-on: windows-latest

    steps:
      - name: Checkout nurgling2
        uses: actions/checkout@v4
        with:
          fetch-depth: 0

      - name: Set up JDK ${{ env.JAVA_VERSION }}
        uses: actions/setup-java@v4
        with:
          java-version: ${{ env.JAVA_VERSION }}
          distribution: 'temurin'

      - name: Cache external libraries
        uses: actions/cache@v4
        with:
          path: lib/ext
          key: extlibs-${{ runner.os }}-${{ hashFiles('build.xml') }}
          restore-keys: |
            extlibs-${{ runner.os }}-

      - name: Fetch and increment version
        shell: pwsh
        run: |
          # Get version.num from build.xml
          $buildXml = Get-Content "build.xml" -Raw
          if ($buildXml -match 'version\.num"\s+value="([^"]+)"') {
            $versionNum = $matches[1]
          } else {
            $versionNum = "2.103"
          }
          Write-Host "version.num from build.xml: $versionNum"

          $verUrl = "https://raw.githubusercontent.com/${{ env.RELEASE_REPO }}/${{ env.RELEASE_BRANCH }}/ver"
          try {
            $currentVer = (Invoke-WebRequest -Uri $verUrl -UseBasicParsing).Content.Split("`n")[0].Trim()
            Write-Host "Current version in release repo: $currentVer"
            $parts = $currentVer.Split(".")
            $currentMajorMinor = "$($parts[0]).$($parts[1])"

            if ($currentMajorMinor -eq $versionNum) {
              $buildNum = [int]$parts[-1] + 1
              Write-Host "Same major.minor version, incrementing build number to: $buildNum"
            } else {
              $buildNum = 0
              Write-Host "Major.minor version changed ($currentMajorMinor -> $versionNum), starting at build number: $buildNum"
            }
          } catch {
            Write-Host "Could not fetch version from release repo, starting at build 0"
            $buildNum = 0
          }
          "#Build Number for ANT. Do not edit!`nbuild.number=$buildNum" | Out-File -FilePath "build.num" -Encoding ASCII -NoNewline
          Write-Host "Created build.num with build.number=$buildNum"

      - name: Build with Ant
        run: ant release

      - name: Add batch files to version manifest
        shell: pwsh
        run: |
          $files = @("run_updater.bat", "run_updater_latest.bat", "run_updater_stable.bat", "nurgling_launcher.jar")
          foreach ($file in $files) {
            $path = "release\$file"
            if (Test-Path $path) {
              $hash = (Get-FileHash $path -Algorithm SHA256).Hash.ToLower()
              Add-Content -Path "release\ver" -Value "$file=$hash"
              Write-Host "Added $file=$hash"
            } else {
              Write-Host "Warning: $file not found in release folder"
            }
          }

      - name: Verify build artifacts
        shell: pwsh
        run: |
          $requiredFiles = @("hafen.jar", "ver", "nurgling_launcher.jar", "nurgling-res.jar")
          foreach ($file in $requiredFiles) {
            if (!(Test-Path "release\$file")) {
              Write-Error "Missing required file: release\$file"
              exit 1
            }
          }

          $version = (Get-Content "release\ver" -First 1).Trim()
          Write-Host "Build successful - Version: $version"
          echo "VERSION=$version" >> $env:GITHUB_ENV

      - name: Upload build artifacts
        uses: actions/upload-artifact@v4
        with:
          name: nurgling-release-${{ env.VERSION }}
          path: release/
          retention-days: 30

      - name: Push to release repository
        shell: pwsh
        env:
          RELEASE_TOKEN: ${{ secrets.RELEASE_REPO_TOKEN }}
        run: |
          git config --global user.name "GitHub Actions"
          git config --global user.email "actions@github.com"

          git clone "https://x-access-token:$env:RELEASE_TOKEN@github.com/${{ env.RELEASE_REPO }}.git" release-repo
          cd release-repo

          git checkout ${{ env.RELEASE_BRANCH }}
          if ($LASTEXITCODE -ne 0) {
            git checkout -b ${{ env.RELEASE_BRANCH }}
          }

          Get-ChildItem -Exclude ".git" | Remove-Item -Recurse -Force

          Copy-Item "..\release\*" . -Recurse

          git add -A

          $message = "Release ${{ env.VERSION }}"
          if ("${{ github.event.inputs.release_message }}" -ne "") {
            $message = "$message - ${{ github.event.inputs.release_message }}"
          } else {
            $triggerMsg = "${{ github.event.head_commit.message }}" -replace "`n.*", ""
            if ($triggerMsg.Length -gt 50) {
              $triggerMsg = $triggerMsg.Substring(0, 50) + "..."
            }
            $message = "$message - $triggerMsg"
          }

          git commit -m $message
          git push origin ${{ env.RELEASE_BRANCH }}

          Write-Host "Successfully pushed to ${{ env.RELEASE_REPO }}@${{ env.RELEASE_BRANCH }}"
